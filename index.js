!function(e){var t={};function a(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=e,a.c=t,a.d=function(e,t,r){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(r,s,function(t){return e[t]}.bind(null,s));return r},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=3)}([function(e,t,a){let r=a(12);class s{openStationsDB(){return new r("./db/stations.db")}openMarketDB(){return new r("./db/market.db")}openTrackingDB(){return new r("./db/tracking.db")}getStationByMarketId(e){let t=this.openStationsDB(),a=t.prepare("Select * from Stations where marketid = ?").get(e);return t.close(),a}updateStationWithMarketId(e,t,a,r,s,i,n){let o=this.openStationsDB();o.prepare("UPDATE Stations SET benprice=?,bendemand=?,ltdprice=?,ltddemand=?,musprice=?,musdemand=?,paiprice=?,paidemand=?,serprice=?,serdemand=?,voprice=?,vodemand=?,updated=julianday('now','+2 hours') where marketid = ?").run(t.sellPrice,t.demand,a.sellPrice,a.demand,r.sellPrice,r.demand,s.sellPrice,s.demand,i.sellPrice,i.demand,n.sellPrice,n.demand,e),o.close()}updateStationWithMarketIdDist(e,t,a,r,s,i,n,o){let d=this.openStationsDB();d.prepare("UPDATE Stations SET benprice=?,bendemand=?,ltdprice=?,ltddemand=?,musprice=?,musdemand=?,paiprice=?,paidemand=?,serprice=?,serdemand=?,voprice=?,vodemand=?,lsfromstar=?,updated=julianday('now','+2 hours') where marketid = ?").run(t.sellPrice,t.demand,a.sellPrice,a.demand,r.sellPrice,r.demand,s.sellPrice,s.demand,i.sellPrice,i.demand,n.sellPrice,n.demand,o,e),d.close()}addNewStation(e,t,a,r,s,i,n,o,d,l,c){let m=this.openStationsDB();m.prepare("INSERT INTO Stations(name,system,benprice,bendemand,ltdprice,ltddemand,musprice,musdemand,paiprice,paidemand,serprice,serdemand,voprice,vodemand,updated,lsfromstar,marketid,largestpad) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,julianday('now','+2 hours'),?,?,?)").run(e,t,a.sellPrice,a.demand,r.sellPrice,r.demand,s.sellPrice,s.demand,i.sellPrice,i.demand,n.sellPrice,n.demand,o.sellPrice,o.demand,d,l,c),m.close()}selectBestPriceByMaterial(e){let t=this.openStationsDB(),a=t.prepare("Select "+e.toLowerCase()+"price as price,datetime(updated) as date,name as station,system From Stations Order By price DESC LIMIT 1").get();return t.close(),a}selectAvgPriceByMaterial(e){let t=this.openStationsDB(),a=t.prepare("Select AVG(price) as price,date From (Select date(updated) as date,"+e.toLowerCase()+"price as price from Stations where "+e.toLowerCase()+"demand > 0) Group by date Order By date DESC LIMIT 1").get();return t.close(),a}selectChartDataByMaterial(e){let t=this.openMarketDB(),a=t.prepare("SELECT priceEnd,priceStart,priceMax,priceMin,datetime(date) as date FROM (SELECT * from "+e+" order by id DESC Limit 24) Order by date ASC Limit 24;").all();return t.close(),a}selectTop50StationsByMaterial(e){let t=this.openStationsDB(),a=t.prepare("SELECT name,largestpad as pad,system,lsfromstar as distance,"+e.toLowerCase()+"price as max,datetime(updated) as updated,"+e.toLowerCase()+"demand as demand from Stations order by max DESC LIMIT 50").all();return t.close(),a}addNewMarketSessionByMaterialInMarketHistory(e,t){let a=this.openMarketDB();a.prepare("INSERT INTO "+e+"(priceStart,priceEnd,priceMax,priceMin,date) VALUES(?,?,?,?,julianday('now','+2 hours'))").run(t.MarketData[e][0],t.MarketData[e][1],t.MarketData[e][2],t.MarketData[e][3]),a.close()}selectLastEndPriceByMaterial(e){let t=this.openMarketDB(),a=t.prepare("Select priceEnd as price from "+e+" order By id DESC LIMIT 1").get();return t.close(),a}}e.exports=new class{constructor(){return this.Temp=null,null==this.Temp&&(this.Temp=new s),this.Temp}}},function(e,t){e.exports=["BEN","LTD","MUS","PAI","SER","VO"]},function(e,t){e.exports=new class{splitNumber(e){let t=""+e,a="",r=0;for(let e=t.length-1;e>=0;e--)3==r?(a=","+a,r=1):r++,a=t[e]+a;return a}DateDif(e){let t=new Date(e),a=(new Date((new Date).getTime()+72e5).getTime()-t.getTime())/1e3;return a<1?"now":a>59.999?(a/=60,a>59.999?(a/=60,a>23.999?(a/=24,Math.floor(a)+"d ago"):Math.floor(a)+"h ago"):Math.floor(a)+"m ago"):Math.floor(a)+"s ago"}}},function(e,t,a){(function(e){let t=a(4),r=a(5),s=a(6),i=a(7),n=a(8),o=a(13),d=a(15);new class{constructor(a){let l=t();l.use("/videos",i.stream(s.join(e,"/public/vid"))),l.use(t.static("public")),l.set("views",e+"/views"),l.set("view engine","mustache"),l.engine("mustache",r()),d.prepareWeb(l),l.listen(a,(function(){console.log("[WebServer] -> ED-Market listening on port "+a+"!")})),n.ConnectAndSubscribe(),o.prepareMarketData(36e5)}}(8080)}).call(this,"/")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mustache-express")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("express-video")},function(e,t,a){let r=a(9),s=a(10),i=a(11).socket("sub"),n=a(0);e.exports=new class{ConnectAndSubscribe(){i.connect("tcp://eddn.edcd.io:9500"),console.log("[EDDN] -> Connected to EDDN"),i.subscribe(""),i.on("message",e=>{let t=JSON.parse(s.inflateSync(e));if("https://eddn.edcd.io/schemas/commodity/3"==t.$schemaRef){let e=t.message.commodities.find(e=>"benitoite"==e.name)||{sellPrice:0,demand:0},a=t.message.commodities.find(e=>"lowtemperaturediamond"==e.name)||{sellPrice:0,demand:0},s=t.message.commodities.find(e=>"musgravite"==e.name)||{sellPrice:0,demand:0},i=t.message.commodities.find(e=>"painite"==e.name)||{sellPrice:0,demand:0},o=t.message.commodities.find(e=>"serendibite"==e.name)||{sellPrice:0,demand:0},d=t.message.commodities.find(e=>"opal"==e.name)||{sellPrice:0,demand:0},l=n.getStationByMarketId(t.message.marketId);null!=l?(console.log("[Price] -> Updating "+t.message.stationName),0==l.lsfromstar?r("https://www.edsm.net/api-system-v1/stations?systemName="+t.message.systemName.replace("+","%2B")).then((function(r){const l=JSON.parse(r.body);let c=0;c=Math.round(l.stations.find((function(e){return e.marketId==t.message.marketId})).distanceToArrival),console.log("================================\nMissing DIST found!! New dist: "+c),n.updateStationWithMarketIdDist(t.message.marketId,e,a,s,i,o,d,c)})):n.updateStationWithMarketId(t.message.marketId,e,a,s,i,o,d)):(console.log("[Price] -> Creating "+t.message.stationName),r("https://www.edsm.net/api-system-v1/stations?systemName="+t.message.systemName.replace("+","%2B")).then((function(r){const l=JSON.parse(r.body);let c=0,m="M";l.stations&&null!=l.stations.find((function(e){return e.marketId==t.message.marketId}))&&(c=Math.round(l.stations.find((function(e){return e.marketId==t.message.marketId})).distanceToArrival),"Outpost"!=l.stations.find((function(e){return e.marketId==t.message.marketId})).type&&(m="L")),n.addNewStation(t.message.stationName,t.message.systemName,e,a,s,i,o,d,c,t.message.marketId,m)})))}}),i.on("disconnect",()=>{i.connect("tcp://eddn.edcd.io:9500"),i.subscribe("")})}}},function(e,t){e.exports=require("got")},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("zeromq/v5-compat")},function(e,t){e.exports=require("better-sqlite3")},function(e,t,a){const r=a(1),s=a(0),i=a(14);e.exports=new class{save1min(e){let t=[];for(let e=0;e<r.length;e++){let a=r[e],i=s.selectBestPriceByMaterial(a);t.push(i.price)}i.updatePrices(t),setTimeout(()=>{this.save1min(e)},e/60)}save60min(e){console.log("================================\nClosing market session");for(let t=0;t<r.length;t++){let a=r[t],i=s.selectBestPriceByMaterial(a);e.updatePrice(i.price,a),s.addNewMarketSessionByMaterialInMarketHistory(a,e)}e.prepareMarketData()}checksave(){0==(new Date).getMinutes()&&0==(new Date).getSeconds()&&this.save60min(i)}prepareMarketData(e){i.prepareMarketData(),this.save1min(e),setInterval(()=>{this.checksave()},1e3)}}},function(e,t,a){let r=a(0),s=a(1);e.exports=new class{constructor(){this.MarketData={}}prepareMarketData(){console.log("[MarketChart] -> Starting new market session");for(let e=0;e<s.length;e++){let t=s[e];const a=r.selectLastEndPriceByMaterial(t);if(this.MarketData[t]=[parseInt(a.price),0,parseInt(a.price),parseInt(a.price)],0==this.MarketData[t][0]){let e=r.selectBestPriceByMaterial(t);this.MarketData[t][0]=e.price}}}updatePrices(e){console.log("[MarketChart] -> Updating price table");for(let t=0;t<s.length;t++){let a=s[t];e[t]<23e5&&(this.MarketData[a][2]<e[t]&&(this.MarketData[a][2]=e[t]),(this.MarketData[a][3]>e[t]&&0!=e[t]||0==this.MarketData[a][3])&&(this.MarketData[a][3]=e[t]),this.MarketData[a][1]=e[t]),console.log("[MarketChart] -> "+a+":"+JSON.stringify(this.MarketData[a]))}}updatePrice(e,t){e<23e5&&(this.MarketData[t][2]<e&&(this.MarketData[t][2]=e),(this.MarketData[t][3]>e&&0!=e||0==this.MarketData[t][3])&&(this.MarketData[t][3]=e),this.MarketData[t][1]=e)}}},function(e,t,a){let r=a(16),s=a(1);e.exports=new class{constructor(){this.FullNames=["Benitoite","Low Temperature Diamonds","Musgravite","Painite","Serendibite","Void Opals"]}prepareWeb(e){for(let t=0;t<this.FullNames.length;t++){let a=this.FullNames[t];e.get("/"+s[t],(function(e,i){r.showDetails(i,s[t],a)})),e.get("/"+s[t]+"/Chart",(function(e,a){r.showChartdata(a,s[t])})),e.get("/"+s[t]+"/Partial",(function(e,a){r.showDetailsPartial(a,s[t])}))}e.get("/",(function(e,t){r.showIndex(t)})),e.get("/Partial",(function(e,t){r.showPartial(t)}))}}},function(e,t,a){a(1);let r=a(0),s=a(17),i=a(2);e.exports=new class{showDetails(e,t,a){let s=[],n=[],o=[],d=[],l=[];r.selectChartDataByMaterial(t).forEach(e=>{l.push(e.date),n.push(e.priceStart),s.push(e.priceEnd),o.push(e.priceMin),d.push(e.priceMax)});let c=r.selectTop50StationsByMaterial(t);c.forEach(e=>{e.Max=i.splitNumber(e.max),e.Distance=i.splitNumber(e.distance),e.Demand=i.splitNumber(e.demand),e.Updated=i.DateDif(e.updated)}),e.render("details",{Stations:c,FullName:a,Name:t,times:JSON.stringify(l),open:JSON.stringify(n),close:JSON.stringify(s),high:JSON.stringify(d),low:JSON.stringify(o)})}showPartial(e){let t=new s("Benitoite","BEN"),a=new s("Low Temperature Diamonds","LTD"),r=new s("Musgravite","MUS"),i=new s("Painite","PAI"),n=new s("Serendibite","SER"),o=new s("Void Opals","VO");t=this.getDataFromDB(t),a=this.getDataFromDB(a),r=this.getDataFromDB(r),i=this.getDataFromDB(i),n=this.getDataFromDB(n),o=this.getDataFromDB(o),e.render("partialMain",{Materials:[t,a,r,i,n,o]})}getDataFromDB(e){let t=e.Name,a=r.selectBestPriceByMaterial(t);return null!=a&&(e.Max=a.price,e.Station=a.station,e.Update=a.date,e.System=a.system),a=r.selectAvgPriceByMaterial(t),null!=a&&(e.Avg=a.price),e}showDetailsPartial(e,t){let a=r.selectTop50StationsByMaterial(t),s=[];a.forEach(e=>{s.push([e.name,e.system,i.splitNumber(e.distance),i.splitNumber(e.max),i.splitNumber(e.demand),i.splitNumber((e.demand/4).toFixed(0)),e.pad,i.DateDif(e.updated)])}),e.json({data:s})}showIndex(e){let t=new s("Benitoite","BEN"),a=new s("Low Temperature Diamonds","LTD"),r=new s("Musgravite","MUS"),i=new s("Painite","PAI"),n=new s("Serendibite","SER"),o=new s("Void Opals","VO");t=this.getDataFromDB(t),a=this.getDataFromDB(a),r=this.getDataFromDB(r),i=this.getDataFromDB(i),n=this.getDataFromDB(n),o=this.getDataFromDB(o),e.render("index",{Materials:[t,a,r,i,n,o]})}showChartdata(e,t){let a=r.selectChartDataByMaterial(t);e.send(a)}}},function(e,t,a){let r=a(2),s=function(e,t){let a=this;this.better=function(){return a.Max>a.Avg},this.worse=function(){return a.Max<a.Avg},this.DisplayStation=function(){return this.Station+"("+this.System+")"},this.max=function(){return r.splitNumber(this.Max)},this.avg=function(){return r.splitNumber(Math.round(this.Avg))},this.Name=t,this.fullName=e};e.exports=s}]);